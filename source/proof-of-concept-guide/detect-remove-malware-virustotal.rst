.. _poc_detect_remove_malware_virustotal:

Detecting and removing malware - VirusTotal integration
=======================================================

Wazuh has the ability to integrate with VirusTotal API, running a query when a file change is detected. For this integration we use the ``ossec-integratord`` component that runs on the Wazuh manager.

Please, check our :ref:`VirusTotal documentation <https://documentation.wazuh.com/current/user-manual/capabilities/virustotal-scan/index.html>` for more information about this particular use case.

Prerequisites
-------------

- A VirusTotal API key (https://www.virustotal.com)
- Python installed in the Wazuh manager (``yum -y install python2``)
- Custom rules and decoders in the Wazuh manager
- Custom active response script in the monitored endpoint (Linux RHEL)
- Install ``jq`` in the monitored endpoint to process the input JSON in the AR script (``yum -y install jq``)

Configuring VirusTotal integration
----------------------------------

- Enable Virustotal integration on the Wazuh manager, in the file ``/var/ossec/etc/ossec.conf``

    .. code-block:: XML

        <ossec_config>
            <integration>
            <name>virustotal</name>
            <api_key>${your_virustotal_api_key}</api_key>
            <rule_id>100200,100201</rule_id>
            <alert_format>json</alert_format>
            </integration>
        </ossec_config>

- Add these rules to /var/ossec/etc/rules/local_rules.xml:

    .. code-block:: XML

        <group name="syscheck,pci_dss_11.5,nist_800_53_SI.7,">
            <!-- Rules for Linux systems -->
            <rule id="100200" level="7">
                <if_sid>550</if_sid>
                <field name="file">/root</field>
                <description>File modified in /root directory.</description>
            </rule>
                <rule id="100201" level="7">
                <if_sid>554</if_sid>
                <field name="file">/root</field>
                <description>File added to /root directory.</description>
            </rule>
        </group>


The above rules are created to limit the times VirusTotal integration is triggered due to limitations in queries per minute (when using a free VirusTotal API key). This way we limit the integration to files being created or modified only in ``/root`` directory:

Configuring active response to remove malicious files
------------------------------------------------------

Additionally, once VirusTotal detects a file as a threat (positive match with antivirus engines), Wazuh will trigger an active response to remove the file from the system. The following changes are done on the Wazuh manager system:

Edit ``/var/ossec/etc/decoders/local_decoder.xml`` and add the following decoder:

    .. code-block:: XML

        <decoder name="ar_log_fields">
            <parent>ar_log</parent>
            <regex offset="after_parent">^(\S+) Removed threat located at (\S+)</regex>
            <order>script_name, path</order>
        </decoder>
    
- Add the auto-remove rule to /var/ossec/etc/rules/local_rules.xml:

    .. code-block:: XML

        <group name="virustotal,">
        <rule id="100092" level="12">
            <if_sid>657</if_sid>
            <match>Successfully removed threat</match>
            <description>$(parameters.program) removed threat located at $(parameters.alert.data.virustotal.source.file)</description>
        </rule>

        <rule id="100093" level="12">
            <if_sid>657</if_sid>
            <match>Error removing threat</match>
            <description>Error removing threat located at $(parameters.alert.data.virustotal.source.file)</description>
        </rule>
        </group>

- Append the following blocks to the Wazuh manager ``/var/ossec/etc/ossec.conf`` file:  

    .. code-block:: XML

        <ossec_config>
            <command>
                <name>remove-threat</name>
                <executable>remove-threat.sh</executable>
                <timeout_allowed>no</timeout_allowed>
            </command>

            <active-response>
                <disabled>no</disabled>
                <command>remove-threat</command>
                <location>local</location>
                <rules_id>87105</rules_id>
            </active-response>

        </ossec_config>

- Restart Wazuh manager to apply configuration changes

    .. code-block:: console

        systemctl restart wazuh-manager

Configuring the Wazuh agent side
--------------------------------

Change the file integrity monitoring settings to monitor ``/root`` in real-time. This change can be done in ``/var/ossec/etc/ossec.conf``

    .. code-block:: XML

        <syscheck>
            <directories whodata="yes">/root</directories>
        </syscheck>

- On the monitored endpoint (Linux RHEL running the Wazuh agent), add the following active response script at ``/var/ossec/active-response/bin/remove-threat.sh``.

    .. code-block:: XML

        #!/bin/bash

        LOCAL=`dirname $0`;
        cd $LOCAL
        cd ../

        PWD=`pwd`

        read INPUT_JSON
        FILENAME=$(echo $INPUT_JSON | jq -r .parameters.alert.data.virustotal.source.file)
        COMMAND=$(echo $INPUT_JSON | jq -r .command)
        LOG_FILE="${PWD}/../logs/active-responses.log"

        #------------------------ Analyze command -------------------------#
        if [ ${COMMAND} = "add" ]
        then
         # Send control message to execd
         printf '{"version":1,"origin":{"name":"remove-threat","module":"active-response"},"command":"check_keys", "parameters":{"keys":[]}}\n'

         read RESPONSE
         COMMAND2=$(echo $RESPONSE | jq -r .command)
         if [ ${COMMAND2} != "continue" ]
         then
          echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Remove threat active response aborted" >> ${LOG_FILE}
          exit 0;
         fi
        fi

        # Removing file
        rm -f $FILENAME
        if [ $? -eq 0 ]; then
         echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Successfully removed threat" >> ${LOG_FILE}
        else
         echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Error removing threat" >> ${LOG_FILE}
        fi

        exit 0;

- Change ``/var/ossec/active-response/bin/remove-threat.sh`` owner and permissions:

    .. code-block:: XML

        chmod 750 /var/ossec/active-response/bin/remove-threat.sh
        chown root:ossec /var/ossec/active-response/bin/remove-threat.sh

- Restart the Wazuh agent, on the monitored endpoint, to apply configuration changes

    .. code-block:: console

        systemctl restart wazuh-agent


Steps to generate the alerts
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

When a file is modified under the monitored directory ``/root``, it will trigger a VirusTotal scan and generate an alert if detected as malicious.

Additionally, the active response has also be configured to remove the threat automatically.

    .. code-block:: console

        cd /root
        curl -LO http://www.eicar.org/download/eicar.com && ls -lah eicar.com
        ls -lah eicar.com

Alerts
^^^^^^

- ``*eicar.com*``

Affected endpoints
^^^^^^^^^^^^^^^^^^

- Linux RHEL