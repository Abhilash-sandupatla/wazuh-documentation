.. Copyright (C) 2021 Wazuh, Inc.
.. meta::
  :description: The Wazuh GCP Pub/Sub module allows you to fetch logs from Google Audit Logs. Learn more about the module's usage in this section.

.. _gcp_cloud_audit_logs:

Audited resources
=================

Google audit logs
-----------------

Google Cloud maintains four `audit logs <https://cloud.google.com/logging/docs/audit>`__ for each Google Cloud project, folder, and organization: **Admin Activity**, **Data Access**, **System Event**, and **Policy Denied**.

* **Admin Activity** audit logs contain log entries for API calls or other administrative actions that modify the configuration or metadata of resources.

* **Data Access** audit logs contain API calls that read the configuration or metadata of resources, as well as user-driven API calls that create, modify or read user-provided resource data.

* **System Event** audit logs contain log entries for Google Cloud administrative actions that modify the configuration of resources. These audit logs are generated by the Google system, therefore, no direct user action will drive them.

* **Policy Denied** audit logs are recorded when a Google Cloud service denies access to a user or service account because of a security policy violation.

Wazuh is able to collect and analyze those logs using the :ref:`GCP Pub/Sub integration <pubsub>`.

Configure Google audit logs collection
--------------------------------------

To enable Google audit logs collection, it is necessary to first ingest the audit logs into a Pub/Sub topic defining a custom log router. To do that, visit the `Google Cloud Logging section  <https://console.cloud.google.com/logs/router>`_ and click on the ``CREATE SINK`` button.

.. thumbnail:: ../../images/gcp/gcp-create-sink-button.png
    :align: center
    :width: 100%

Then, provide a descriptive name for the sink and click on the ``NEXT`` button.

.. thumbnail:: ../../images/gcp/gcp-sink-name.png
    :align: center
    :width: 100%

Once the name for the sink is chosen, it is necessary to select the sink destination. As sink service, choose **Cloud Pub/Sub topic**, and then create or choose a topic to be used as a destination. Then click on the ``NEXT`` button.

.. thumbnail:: ../../images/gcp/gcp-sink-destination.png
    :align: center
    :width: 100%

Finally, use the following query to collect all the audit logs from every project. It is possible to edit it to only collect audit logs from a particular project.

.. code-block:: none

    logName=~("projects/.*/logs/cloudaudit.googleapis.com%2F(activity|data_access|system_event|policy)")

If it is not necessary to filter any logs out of the sink, click on the ``CREATE SINK`` button to create it.

.. thumbnail:: ../../images/gcp/gcp-create-sink.png
    :align: center
    :width: 100%

Once this process is finished, you can configure the :ref:`Wazuh GCP Pub/Sub integration <pubsub>` to process the audit logs of the selected resources as usual.


Kibana dashboard visualization
------------------------------

After configuring the GCP Pub/Sub module to fetch the audit logs from Google Cloud, it is possible to visualize the alerts generated in the Kibana dashboard.

.. thumbnail:: ../../images/gcp/gcp-overview.png
    :align: center
    :width: 100%

Google Cloud logs can be filtered on Kibana by the ``data.gcp.logName`` field:

.. thumbnail:: ../../images/gcp/gcp-kibana-log-filter.png
    :align: center
    :width: 100%

After selecting the ``Exists in`` button, only Google Cloud-related events will appear in the Kibana dashboard.

.. thumbnail:: ../../images/gcp/gcp-kibana-filtered-logs.png
    :align: center
    :width: 100%

If you need information about all the Google services with audit logs that the Wazuh GCP module could analyze, visit `the Google Cloud documentation <https://cloud.google.com/logging/docs/audit/services>`__.
