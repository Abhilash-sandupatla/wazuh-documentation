.. Copyright (C) 2021 Wazuh, Inc.

.. _active_response_removing_malware:


.. meta::
  :description: Learn how to detect and remove malware using Wazuh and VirusTotal. Monitor a folder in real time and remove any new or recently modified file classified as malicious.  


Detecting and removing malware - Virus Total integration
========================================================

VirusTotal is an online portal, owned by Google, that uses many antivirus engines to check for viruses and malware. It provides an API service that Wazuh uses to scan file hashes, domain names, IP addresses, or URLs. For this integration we use the ``wazuh-integratord`` component that runs on the Wazuh manager. Check our :ref:`VirusTotal documentation <virustotal-scan>` for more information about this integration. 

In this use case we scan a directory in real time and scan using VirusTotal every new or recently modified file. If a file is classified as malicious an active response is triggered and the file is removed. 

Prerequisites
-------------

- A `VirusTotal <https://www.virustotal.com>`_ API key
- Python installed on the Wazuh manager
- Custom rules and decoders in the Wazuh manager
- Custom active response script in the monitored endpoint (Linux in this example)
  
Configuring VirusTotal integration
----------------------------------

Insert your VirusTotal API key and enable the VirusTotal integration on the Wazuh manager by adding the following configuration in ``/var/ossec/etc/ossec.conf``. 
  
.. code-block:: none

  <ossec_config>
    <integration>
      <name>virustotal</name>
      <api_key>${your_virustotal_api_key}</api_key>
      <rule_id>100200,100201</rule_id>
      <alert_format>json</alert_format>
    </integration>
  </ossec_config>

  
In this example we limit the scanning to new or recently modified files in  ``/root`` directory due to limitations in queries per minutes when using a free VirusTotal account. To do so, we create custom rules to monitor the  ``/root`` directory and use them to trigger the VirusTotal integration. 
 
Add the following custom rules to ``/var/ossec/etc/rules/local_rules.xml``:
  
.. code-block:: none 

  <group name="syscheck,pci_dss_11.5,nist_800_53_SI.7,">
      <!-- Rules for Linux systems -->
      <rule id="100200" level="7">
          <if_sid>550</if_sid>
          <field name="file">/root</field>
          <description>File modified in /root directory.</description>
      </rule>
          <rule id="100201" level="7">
          <if_sid>554</if_sid>
          <field name="file">/root</field>
          <description>File added to /root directory.</description>
      </rule>
  </group>

This integration will scan using VirusTotal all new or recently modified files in ``/root`` directory. 
  
Configuring Active Response to remove malicious files
-----------------------------------------------------

Once VirusTotal identifies a file as a threat, Wazuh will trigger an active response to remove the file from the system. 


Configuring the Wazuh manager
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Append the following blocks to the Wazuh manager  ``/var/ossec/etc/ossec.conf`` file.
  
.. code-block:: none

  <ossec_config>

      <command>
          <name>remove-threat</name>
          <executable>remove-threat.sh</executable>
          <timeout_allowed>no</timeout_allowed>
      </command>
  
      <active-response>
          <disabled>no</disabled>
          <command>remove-threat</command>
          <location>local</location>
          <rules_id>87105</rules_id>
          <timeout>600</timeout>
      </active-response>
  
  </ossec_config>

Edit  ``/var/ossec/etc/decoders/local_decoder.xml`` and add the following decoder:
  
.. code-block:: none

  <decoder name="ar_log_fields">
      <parent>ar_log</parent>
      <regex offset="after_parent">^(\S+) Removed threat located at (\S+)</regex>
      <order>script_name, path</order>
  </decoder>

  
Add the auto-remove rule to ``/var/ossec/etc/rules/local_rules.xml``:
  
.. code-block:: none

  <group name="virustotal,">
      <rule id="100092" level="12">
      <if_sid>657</if_sid>
      <match>remove-threat.sh</match>
      <description>$(parameters.program) removed threat located at $(parameters.alert.data.virustotal.source.file)</description>
      </rule>
  </group>
  
  
Restart Wazuh manager to apply configuration changes.

.. include:: ../../../../_templates/common/restart_manager.rst
  
Configuring the Wazuh agent side
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Change the file integrity monitoring settings to monitor ``/root``  in real time. This change can be done in ``/var/ossec/etc/ossec.conf``. 

.. code-block:: none

    <syscheck>
      <directories whodata="yes">/root</directories>
    </syscheck>


Add the following active response script at ``/var/ossec/active-response/bin/remove-threat.sh``. 
  
.. code-block:: none

   #!/bin/bash
   
   LOCAL=`dirname $0`;
   cd $LOCAL
   cd ../
   
   PWD=`pwd`
   
   INPUT_JSON=$(cat -)
   FILENAME=$(echo $INPUT_JSON | jq -r .parameters.alert.data.virustotal.source.file)
   echo $FILENAME
   LOG_FILE="${PWD}/../logs/active-responses.log"
   
   # Removing file
   rm -f $FILENAME
   if [ $? -eq 0 ]; then
       echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Successfully removed thread" >> ${LOG_FILE}
   else
       echo "`date '+%Y/%m/%d %H:%M:%S'` $0: $INPUT_JSON Error removing threat" >> ${LOG_FILE}
   fi
   
   exit 0;



.. note:: Make sure that `jq <https://stedolan.github.io/jq/>`_ is installed. 
  
Change ``/var/ossec/active-response/bin/remove-threat.sh`` owner and permissions.
  
.. code-block:: none 

  chmod 750 /var/ossec/active-response/bin/remove-threat.sh
  chown root:ossec /var/ossec/active-response/bin/remove-threat.sh

  
Restart Wazuh agent, on the monitored endpoint, to apply configuration changes. 
  
.. include:: ../../../../_templates/common/linux/restart_agent.rst


  
Steps to generate the alerts
----------------------------

When a file is modified under the monitored directory ``/root``, it will trigger a VirusTotal scan and generate an alert if detected as malicious. 
  
Additionally, the active response has also be configured to remove the threat automatically.
  
.. code-block:: none

  cd /root
  curl -LO http://www.eicar.org/download/eicar.com && ls -lah eicar.com
  ls -lah eicar.com

  

  